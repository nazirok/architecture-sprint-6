## Проблемы

1. Запросы к ***ins-product-aggregator*** синхронные. Процедура получения информации со страховых компаний и их аггрегация довольно длительная операция. При этом если при взаимодействии с API какой то страховой компании завершится ошибкой то вся операция завершиться ошибкой. Также во время операции тратяться лишние ресурсы(например core-app должен держать соединение с ins-product-aggregator). Главное что процедура получения информации из ins-product-aggregator не обязательно должна быть синхронной.
2. По мере роста количества страховых компаний увеличится время выполнения операции. Также увеличится риск ошибки. Также увеличится сложность.

Итого: 
1. нет требований что эти процедуры были именно синхронными. 
2. Имеем много проблем из-за синхронного варианта
3. Учитывая имеющиеся проблемы и планируемый рост, нужно взаимодействие переделать на асинхронный вариант.

## Решение

1. Для аснхронного взаимодействия внедрить брокер сообщений. Сценарий pub/sub. Гарантия доставки at least once.
2. Сервис ***ins-product-aggregator*** будет периодически, например раз в 15 минут, выполнять задание:
    1. Собирать данные со страховых компаний и публиковать в соотвествующий топик. По каждой страховой компании имеет смысл отправлять отдельное сообщение, так как если отправлять все вместе размер сообщения может стать большим(учитывая ожидаемый рост) и даже не уместиться в ограничения брокера.
    2. Сервисы ***core-app*** и ***ins-comp-settlement*** подпишуться на соотвествущий тоипк в брокере и будут получать информацию от страховых компаний от ***ins-product-aggregator***
3. Сервис ***core-app*** при оформалении старховки будет публиковать в брокер информацию по оформленной старховке. В этом сценарии:
    1. Есть риски возникновения несогласованности данных(в базу данные по старховке записали но в брокер не смогли)
    2. Несогласованность данных недопустима так как могут быть потери в расчетах по старховке
Поэтому для данного сценария имеест смысл внедрить паттерн Transactional outbox.
4. Сервис ***ins-comp-settlement*** подпишется в брокере на соотвествущий топик и будет получать данные о созданных старховках от ***core-app***